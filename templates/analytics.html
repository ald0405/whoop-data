<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics & Insights - Health Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #1e1e2e;
            --bg-card: #313244;
            --text-primary: #f1f1f1;
            --text-secondary: #a6adc8;
            --color-success: #50fa7b;
            --color-alert: #ff6b6b;
            --color-opportunity: #ffb86c;
            --color-primary: #8be9fd;
            --color-accent: #bd93f9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2em;
            font-weight: 600;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .nav-links a:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .nav-links a.active {
            background: var(--color-primary);
            color: var(--bg-primary);
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2em;
            color: var(--text-secondary);
        }
        
        .error {
            background: rgba(255, 107, 107, 0.2);
            color: var(--color-alert);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid var(--color-alert);
        }
        
        /* Insights Panel */
        .insights-section {
            margin-bottom: 30px;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .insight-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--color-primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .insight-card.success {
            border-left-color: var(--color-success);
        }
        
        .insight-card.alert {
            border-left-color: var(--color-alert);
        }
        
        .insight-card.opportunity {
            border-left-color: var(--color-opportunity);
        }
        
        .insight-emoji {
            font-size: 1.8em;
            line-height: 1;
        }
        
        .insight-text {
            flex: 1;
            font-size: 0.95em;
        }
        
        /* Charts Grid */
        .charts-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .chart-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .chart-card h3 {
            color: var(--text-secondary);
            font-size: 1em;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .chart-container.small {
            height: 200px;
        }
        
        /* Top Lever Callout */
        .top-lever {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: var(--bg-primary);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 6px 12px rgba(139, 233, 253, 0.3);
        }
        
        .top-lever h2 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        
        .top-lever p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        /* Factor Importance List */
        .factor-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .factor-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .factor-bar {
            flex: 1;
            height: 32px;
            background: var(--bg-primary);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .factor-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--bg-primary);
        }
        
        .factor-label {
            min-width: 150px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .factor-threshold {
            min-width: 100px;
            font-size: 0.85em;
            color: var(--color-success);
            text-align: right;
        }
        
        /* Correlation Matrix */
        .correlation-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .correlation-item {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--color-primary);
        }
        
        .correlation-metrics {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .correlation-strength {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        
        .correlation-strength.strong {
            background: var(--color-success);
            color: var(--bg-primary);
        }
        
        .correlation-strength.moderate {
            background: var(--color-opportunity);
            color: var(--bg-primary);
        }
        
        .correlation-strength.weak {
            background: var(--text-secondary);
            color: var(--bg-primary);
        }
        
        .correlation-explanation {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        .correlation-example {
            font-size: 0.85em;
            color: var(--color-accent);
            font-style: italic;
        }
        
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Analytics & Insights</h1>
            <nav class="nav-links">
                <a href="/">Home</a>
                <a href="/dashboard">Dashboard</a>
                <a href="/analytics" class="active">Analytics</a>
            </nav>
        </div>
        
        <div id="loading-state" class="loading">
            ðŸ”„ Loading analytics data...
        </div>
        
        <div id="error-state" class="error" style="display: none;"></div>
        
        <div id="analytics-content" style="display: none;">
            <!-- Top Lever -->
            <div id="top-lever" class="top-lever"></div>
            
            <!-- Weekly Insights -->
            <section class="insights-section">
                <h2 class="section-title">ðŸ’¡ Weekly Insights</h2>
                <div id="insights-grid" class="insights-grid"></div>
            </section>
            
            <!-- Factor Importance -->
            <section class="charts-section">
                <h2 class="section-title">ðŸŽ¯ What Drives Your Recovery</h2>
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Factor Importance</h3>
                        <div id="factor-list" class="factor-list"></div>
                    </div>
                    <div class="chart-card">
                        <h3>Model Performance</h3>
                        <div id="model-info" style="padding: 20px;">
                            <div style="font-size: 3em; text-align: center; color: var(--color-success); margin-bottom: 10px;" id="model-accuracy">--</div>
                            <div style="text-align: center; color: var(--text-secondary);" id="model-explanation">Loading model performance...</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Correlations -->
            <section class="charts-section">
                <h2 class="section-title">ðŸ”— Metric Relationships</h2>
                <div class="charts-grid">
                    <div class="chart-card" style="grid-column: 1 / -1;">
                        <h3>Significant Correlations (p < 0.05)</h3>
                        <div id="correlation-list" class="correlation-list"></div>
                    </div>
                </div>
            </section>
            
            <!-- Trends -->
            <section class="charts-section">
                <h2 class="section-title">ðŸ“ˆ 30-Day Trends</h2>
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3 id="recovery-trend-title">Recovery Trend</h3>
                        <div class="chart-container small">
                            <canvas id="recoveryTrendChart"></canvas>
                        </div>
                        <div id="recovery-trend-desc" style="margin-top: 12px; font-size: 0.9em; color: var(--text-secondary);"></div>
                    </div>
                    <div class="chart-card">
                        <h3 id="hrv-trend-title">HRV Trend</h3>
                        <div class="chart-container small">
                            <canvas id="hrvTrendChart"></canvas>
                        </div>
                        <div id="hrv-trend-desc" style="margin-top: 12px; font-size: 0.9em; color: var(--text-secondary);"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <script>
        // Chart.js defaults
        Chart.defaults.color = '#a6adc8';
        Chart.defaults.borderColor = 'rgba(68, 71, 90, 0.3)';
        
        // Fetch and render analytics
        async function loadAnalytics() {
            try {
                const response = await fetch('/analytics/summary');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                renderAnalytics(data);
                
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';
            } catch (error) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-state').textContent = `Error loading analytics: ${error.message}`;
                console.error('Analytics error:', error);
            }
        }
        
        function renderAnalytics(data) {
            // Top Lever
            const topLever = document.getElementById('top-lever');
            topLever.innerHTML = `
                <h2>ðŸŽ¯ Your Top Lever</h2>
                <p>${data.factor_importance.top_lever}</p>
            `;
            
            // Weekly Insights
            const insightsGrid = document.getElementById('insights-grid');
            data.weekly_insights.insights.forEach(insight => {
                const card = document.createElement('div');
                card.className = `insight-card ${insight.category}`;
                card.innerHTML = `
                    <div class="insight-emoji">${insight.emoji}</div>
                    <div class="insight-text">${insight.insight_text}</div>
                `;
                insightsGrid.appendChild(card);
            });
            
            // Factor Importance
            const factorList = document.getElementById('factor-list');
            data.factor_importance.factors.slice(0, 7).forEach(factor => {
                const item = document.createElement('div');
                item.className = 'factor-item';
                item.innerHTML = `
                    <div class="factor-label">${factor.factor_name}</div>
                    <div class="factor-bar">
                        <div class="factor-fill" style="width: ${factor.importance_percentage}%">
                            ${factor.importance_percentage.toFixed(1)}%
                        </div>
                    </div>
                    <div class="factor-threshold">${factor.actionable_threshold || ''}</div>
                `;
                item.title = factor.explanation;
                factorList.appendChild(item);
            });
            
            // Model Performance
            const accuracyPct = (data.factor_importance.model_accuracy * 100).toFixed(0);
            document.getElementById('model-accuracy').textContent = `${accuracyPct}%`;
            document.getElementById('model-explanation').textContent = data.factor_importance.explanation;
            
            // Correlations
            const corrList = document.getElementById('correlation-list');
            data.top_correlations.forEach(corr => {
                const item = document.createElement('div');
                item.className = 'correlation-item';
                item.innerHTML = `
                    <div class="correlation-metrics">
                        ${corr.metric_1} â†” ${corr.metric_2}
                        <span class="correlation-strength ${corr.significance}">${corr.significance}</span>
                        <span style="color: var(--text-secondary); margin-left: 10px;">r = ${corr.correlation.toFixed(2)}</span>
                    </div>
                    <div class="correlation-explanation">${corr.explanation}</div>
                    ${corr.example ? `<div class="correlation-example">ðŸ’¡ ${corr.example}</div>` : ''}
                `;
                corrList.appendChild(item);
            });
            
            // Recovery Trend Chart
            renderTrendChart('recoveryTrendChart', data.recovery_trend, '#8be9fd');
            document.getElementById('recovery-trend-desc').textContent = data.recovery_trend.trend_description;
            document.getElementById('recovery-trend-title').innerHTML = 
                `Recovery Trend <span style="color: ${getTrendColor(data.recovery_trend.trend_direction)}">${getTrendArrow(data.recovery_trend.trend_direction)} ${Math.abs(data.recovery_trend.trend_percentage).toFixed(1)}%</span>`;
            
            // HRV Trend Chart
            renderTrendChart('hrvTrendChart', data.hrv_trend, '#ff79c6');
            document.getElementById('hrv-trend-desc').textContent = data.hrv_trend.trend_description;
            document.getElementById('hrv-trend-title').innerHTML = 
                `HRV Trend <span style="color: ${getTrendColor(data.hrv_trend.trend_direction)}">${getTrendArrow(data.hrv_trend.trend_direction)} ${Math.abs(data.hrv_trend.trend_percentage).toFixed(1)}%</span>`;
        }
        
        function renderTrendChart(canvasId, trendData, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const labels = trendData.data_points.slice(-14).map(p => {
                const date = new Date(p.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            const values = trendData.data_points.slice(-14).map(p => p.value);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderColor: color,
                        backgroundColor: `${color}33`,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#313244',
                            titleColor: '#f1f1f1',
                            bodyColor: '#a6adc8',
                            borderColor: '#44475a',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Value: ${context.parsed.y.toFixed(1)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { maxTicksLimit: 7 }
                        },
                        y: {
                            grid: { color: 'rgba(68, 71, 90, 0.3)' }
                        }
                    }
                }
            });
        }
        
        function getTrendArrow(direction) {
            if (direction === 'up') return 'â†‘';
            if (direction === 'down') return 'â†“';
            return 'â†’';
        }
        
        function getTrendColor(direction) {
            if (direction === 'up') return '#50fa7b';
            if (direction === 'down') return '#ff6b6b';
            return '#ffb86c';
        }
        
        // Load analytics on page load
        loadAnalytics();
    </script>
</body>
</html>
