<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Dashboard - Set Me Up For The Day</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #1e1e2e;
            --bg-card: #313244;
            --grid-color: rgba(68, 71, 90, 0.3);
            --text-primary: #f1f1f1;
            --text-secondary: #a6adc8;
            --spine-color: #313244;
            
            /* Metric colors */
            --color-recovery: #8be9fd;
            --color-bedtime: #bd93f9;
            --color-strain: #50fa7b;
            --color-efficiency: #ffb86c;
            --color-hrv: #ff79c6;
            --color-rhr: #f1fa8c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-weight: 600;
            font-size: 2em;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .nav-links a:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .card h3 {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .card-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .metric-value {
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            height: 300px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .error {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .transport-line {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .transport-line.good {
            border-left: 4px solid var(--color-strain);
        }
        
        .transport-line.disrupted {
            border-left: 4px solid #ff6b6b;
        }
        
        .line-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .line-status {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* New styles for improvements */
        .status-section {
            background: linear-gradient(135deg, rgba(139, 233, 253, 0.1), rgba(189, 147, 249, 0.1));
            border: 2px solid rgba(139, 233, 253, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-card {
            background: rgba(49, 50, 68, 0.8);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .status-card.green { border-color: #50fa7b; }
        .status-card.yellow { border-color: #ffb86c; }
        .status-card.red { border-color: #ff6b6b; }
        
        .status-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .badge-green { background: rgba(80, 250, 123, 0.2); color: #50fa7b; }
        .badge-yellow { background: rgba(255, 184, 108, 0.2); color: #ffb86c; }
        .badge-red { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        
        .section-header {
            font-size: 1.5em;
            font-weight: 600;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(139, 233, 253, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-icon {
            cursor: help;
            opacity: 0.6;
            transition: opacity 0.2s;
            font-size: 0.8em;
            margin-left: 8px;
        }
        
        .info-icon:hover {
            opacity: 1;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .recommendation {
            background: rgba(139, 233, 253, 0.1);
            border-left: 4px solid #8be9fd;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÉ Set Me Up For The Day</h1>
            <nav class="nav-links">
                <a href="/">Home</a>
                <a href="/analytics">üìä Analytics</a>
            </nav>
        </div>
        
        <!-- Quick Status Section -->
        <div class="status-section">
            <h2 style="margin: 0 0 5px 0; font-size: 1.3em;">‚ö° Your Status Right Now</h2>
            <p style="margin: 0 0 15px 0; color: var(--text-secondary); font-size: 0.9em;">Quick overview of your readiness and key metrics</p>
            <div class="status-grid" id="statusGrid">
                <div class="loading">Loading status...</div>
            </div>
            <div id="recommendation" style="margin-top: 15px;"></div>
        </div>
        
        <h2 class="section-header">
            <span>üåç Context & Environment</span>
        </h2>
        
        <div class="info-cards">
            <div class="card" id="weather-card">
                <h3>‚òÄÔ∏è Weather <span class="info-icon" title="Current weather conditions and forecast for planning your day">‚ÑπÔ∏è</span></h3>
                <div class="card-content">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            
            <div class="card" id="transport-card">
                <h3>üöá Transport <span class="info-icon" title="TfL line status and next train arrivals">‚ÑπÔ∏è</span></h3>
                <div class="card-content">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            
            <div class="card" id="tide-card">
                <h3>üåä Thames Tide <span class="info-icon" title="Current tide level and forecast for riverside walks">‚ÑπÔ∏è</span></h3>
                <div class="card-content">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            
            <div class="card" id="hotspots-card">
                <h3>üö∂ Perfect Walk Times <span class="info-icon" title="Optimal times for riverside walks based on weather, tide, and conditions">‚ÑπÔ∏è</span></h3>
                <div class="card-content">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <h2 class="section-header">
            <span>üìä Your Health Metrics (Last 7 Days)</span>
            <span style="font-size: 0.6em; font-weight: 400; color: var(--text-secondary);">Hover over charts for details</span>
        </h2>
        
        <div class="charts-grid">
            <div class="chart-container">
                <canvas id="recoveryChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="hrvChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="rhrChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="strainChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="sleepEfficiencyChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="remPercentageChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        // Chart.js default configuration
        Chart.defaults.color = '#a6adc8';
        Chart.defaults.borderColor = 'rgba(68, 71, 90, 0.3)';
        Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif";
        
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#313244',
                        titleColor: '#f1f1f1',
                        bodyColor: '#a6adc8',
                        borderColor: '#44475a',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxTicksLimit: 7
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(68, 71, 90, 0.3)'
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.4,
                        borderWidth: 3
                    },
                    point: {
                        radius: 4,
                        hoverRadius: 6,
                        borderWidth: 2
                    }
                }
            }
        };
        
        function createChart(canvasId, label, metricData, color, unit = '', higherIsBetter = true) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const data = metricData.last_7_days;
            
            // Generate labels (days ago)
            const labels = data.map((_, i) => {
                if (i === 0) return 'Today';
                return `${i}d ago`;
            }).reverse();
            
            const values = [...data].reverse();
            
            // Calculate trend
            const avg7 = metricData.avg_7_days;
            const avg28 = metricData.avg_28_days;
            let trendArrow = '';
            let trendColor = '';
            
            if (avg7 != null && avg28 != null) {
                if (avg7 > avg28) {
                    trendArrow = higherIsBetter ? '‚Üë' : '‚Üì';
                    trendColor = higherIsBetter ? '#50fa7b' : '#ff6b6b';
                } else if (avg7 < avg28) {
                    trendArrow = higherIsBetter ? '‚Üì' : '‚Üë';
                    trendColor = higherIsBetter ? '#ff6b6b' : '#50fa7b';
                } else {
                    trendArrow = '‚Üí';
                    trendColor = '#ffb86c';
                }
            }
            
            // Build subtitle text
            let subtitle = '';
            if (avg7 != null) subtitle += `7d avg: ${avg7}${unit}`;
            if (avg28 != null) subtitle += ` | 28d avg: ${avg28}${unit}`;
            if (trendArrow) subtitle += ` ${trendArrow}`;
            
            return new Chart(ctx, {
                ...chartConfig,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: values,
                        borderColor: color,
                        backgroundColor: color + '33',
                        pointBackgroundColor: color,
                        pointBorderColor: color,
                        fill: true
                    }]
                },
                options: {
                    ...chartConfig.options,
                    plugins: {
                        ...chartConfig.options.plugins,
                        title: {
                            display: true,
                            text: label + (unit ? ` (${unit})` : ''),
                            color: '#f1f1f1',
                            font: {
                                size: 14,
                                weight: '600'
                            },
                            padding: {
                                bottom: 5
                            }
                        },
                        subtitle: {
                            display: true,
                            text: subtitle,
                            color: trendColor || '#a6adc8',
                            font: {
                                size: 11,
                                weight: '400'
                            },
                            padding: {
                                bottom: 10
                            }
                        }
                    }
                }
            });
        }
        
        async function loadHealthMetrics() {
            try {
                const response = await fetch('/dashboard/health-metrics');
                const data = await response.json();
                
                // Create charts (pass full metric data, not just last_7_days)
                // Last param: true = higher is better, false = lower is better
                createChart('recoveryChart', 'Recovery Score', data.recovery_score, '#8be9fd', '%', true);
                createChart('hrvChart', 'HRV', data.hrv, '#ff79c6', 'ms', true);
                createChart('rhrChart', 'Resting Heart Rate', data.rhr, '#f1fa8c', 'bpm', false); // Lower is better
                createChart('strainChart', 'Strain', data.strain, '#50fa7b', '', true);
                createChart('sleepEfficiencyChart', 'Sleep Efficiency', data.sleep_efficiency, '#ffb86c', '%', true);
                createChart('remPercentageChart', 'REM Sleep', data.rem_percentage, '#bd93f9', '%', true);
                
            } catch (error) {
                console.error('Error loading health metrics:', error);
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.innerHTML = '<div class="error">Failed to load health metrics</div>';
                });
            }
        }
        
        async function loadWeather() {
            try {
                const response = await fetch('/dashboard/weather-extended');
                const data = await response.json();
                
                const weatherCard = document.getElementById('weather-card');
                let html = `
                    <div class="metric-row">
                        <span class="metric-label">Temperature</span>
                        <span class="metric-value">${data.current.temperature}¬∞C (feels like ${data.current.feels_like}¬∞C)</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Conditions</span>
                        <span class="metric-value">${data.current.conditions}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Wind</span>
                        <span class="metric-value">${data.current.wind_speed} m/s</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Sunrise / Sunset</span>
                        <span class="metric-value">${data.current.sunrise} / ${data.current.sunset}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Air Quality</span>
                        <span class="metric-value">AQI ${data.air_quality.current.aqi} (${data.air_quality.current.description})</span>
                    </div>
                `;
                
                // Add forecast by time of day
                if (data.forecast_by_time && data.forecast_by_time.length > 0) {
                    html += '<div style="border-top: 1px solid rgba(68, 71, 90, 0.5); margin-top: 10px; padding-top: 8px;">';
                    html += '<details style="cursor: pointer;"><summary style="font-weight: 600; color: #a6adc8; padding: 4px 0;">‚òÄÔ∏è Forecast</summary>';
                    html += '<div style="margin-top: 8px; font-size: 0.9em;">';
                    
                    // Group by date for cleaner display
                    let currentDate = null;
                    data.forecast_by_time.slice(0, 12).forEach(forecast => { // Show up to 12 periods (4 days * 3 periods)
                        const date = new Date(forecast.date);
                        const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        
                        if (forecast.date !== currentDate) {
                            if (currentDate !== null) html += '<div style="margin-bottom: 4px;"></div>';
                            currentDate = forecast.date;
                        }
                        
                        html += `
                            <div style="padding: 2px 0; color: #f1f1f1;">
                                <span style="color: #a6adc8;">${dateStr} ${forecast.period}:</span>
                                <span style="color: #ffb86c; font-weight: 600;"> ${forecast.temp_avg}¬∞C</span>
                                <span style="color: #a6adc8; font-size: 0.85em;"> - ${forecast.conditions}</span>
                            </div>
                        `;
                    });
                    
                    html += '</div></details></div>';
                }
                
                weatherCard.querySelector('.card-content').innerHTML = html;
            } catch (error) {
                console.error('Error loading weather:', error);
                document.getElementById('weather-card').querySelector('.card-content').innerHTML = 
                    '<div class="error">Failed to load weather data</div>';
            }
        }
        
        function formatRelativeTime(minutes) {
            if (minutes < 1) return 'Due';
            if (minutes === 1) return '1 min';
            return `${minutes} mins`;
        }
        
        async function loadTransport() {
            try {
                // Fetch line status
                const statusResponse = await fetch('/transport/status');
                const statusData = await statusResponse.json();
                
                // Fetch arrivals
                const arrivalsResponse = await fetch('/transport/arrivals');
                const arrivalsData = await arrivalsResponse.json();
                
                const transportCard = document.getElementById('transport-card');
                let html = '<div style="margin-bottom: 15px;">';
                
                // Line status section
                for (const [line, info] of Object.entries(statusData.lines)) {
                    const isGood = info.status === 'Good Service';
                    html += `
                        <div class="transport-line ${isGood ? 'good' : 'disrupted'}">
                            <div class="line-name">${line}</div>
                            <div class="line-status">${info.status}</div>
                            ${!isGood ? `<div class="line-status">${info.description}</div>` : ''}
                        </div>
                    `;
                }
                
                html += '</div>';
                
                // Next trains section
                if (arrivalsData.arrivals && arrivalsData.arrivals.length > 0) {
                    html += '<div style="border-top: 1px solid rgba(68, 71, 90, 0.5); padding-top: 10px; margin-top: 10px;">';
                    html += '<div style="font-weight: 600; margin-bottom: 8px; color: #a6adc8;">üöâ Next Trains</div>';
                    
                    arrivalsData.arrivals.forEach(arrival => {
                        const timeText = formatRelativeTime(arrival.time_to_station_minutes);
                        // Shorten destination names
                        const dest = arrival.destination.replace(' Underground Station', '').replace(' DLR Station', '');
                        html += `
                            <div style="margin-bottom: 6px; font-size: 0.9em; padding: 4px 0;">
                                <span style="color: #50fa7b; font-weight: 600;">${timeText}</span>
                                <span style="color: #f1f1f1;"> - ${arrival.line} to ${dest}</span>
                                <span style="color: #a6adc8; font-size: 0.85em;"> (${arrival.platform})</span>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                transportCard.querySelector('.card-content').innerHTML = html;
            } catch (error) {
                console.error('Error loading transport:', error);
                document.getElementById('transport-card').querySelector('.card-content').innerHTML = 
                    '<div class="error">Failed to load transport data</div>';
            }
        }
        
        async function loadTideData() {
            try {
                const response = await fetch('/dashboard/daily');
                const data = await response.json();
                
                const tideCard = document.getElementById('tide-card');
                
                if (data.context.tide && !data.context.tide.error) {
                    const tide = data.context.tide;
                    let html = '';
                    
                    // Current tide
                    if (tide.current) {
                        const currentTime = new Date(tide.current.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        html += `
                            <div class="metric-row">
                                <span class="metric-label">Current Level</span>
                                <span class="metric-value">${tide.current.level}${tide.current.unit}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Station</span>
                                <span class="metric-value">${tide.current.station}</span>
                            </div>
                            <div class="metric-row" style="font-size: 0.85em; color: #a6adc8; margin-top: 4px;">
                                <span>Updated: ${currentTime}</span>
                            </div>
                        `;
                    }
                    
                    // Next high tide
                    if (tide.next_high_tide) {
                        const highTime = new Date(tide.next_high_tide.time);
                        const highTimeStr = highTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        const highDateStr = highTime.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        
                        html += `
                            <div style="border-top: 1px solid rgba(68, 71, 90, 0.5); margin-top: 10px; padding-top: 8px;">
                                <div class="metric-row">
                                    <span class="metric-label">Next High Tide</span>
                                    <span class="metric-value" style="color: #8be9fd;">${tide.next_high_tide.height}m</span>
                                </div>
                                <div class="metric-row" style="font-size: 0.85em; color: #a6adc8;">
                                    <span>${highDateStr} at ${highTimeStr}</span>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Next low tide
                    if (tide.next_low_tide) {
                        const lowTime = new Date(tide.next_low_tide.time);
                        const lowTimeStr = lowTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        const lowDateStr = lowTime.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        
                        html += `
                            <div style="border-top: 1px solid rgba(68, 71, 90, 0.5); margin-top: 8px; padding-top: 8px;">
                                <div class="metric-row">
                                    <span class="metric-label">Next Low Tide</span>
                                    <span class="metric-value" style="color: #ffb86c;">${tide.next_low_tide.height}m</span>
                                </div>
                                <div class="metric-row" style="font-size: 0.85em; color: #a6adc8;">
                                    <span>${lowDateStr} at ${lowTimeStr}</span>
                                </div>
                            </div>
                        `;
                    }
                    
                    tideCard.querySelector('.card-content').innerHTML = html;
                } else {
                    tideCard.querySelector('.card-content').innerHTML = 
                        '<div class="error">' + (data.context.tide?.error || 'Failed to load tide data') + '</div>';
                }
            } catch (error) {
                console.error('Error loading tide data:', error);
                document.getElementById('tide-card').querySelector('.card-content').innerHTML = 
                    '<div class="error">Failed to load tide data</div>';
            }
        }
        
        async function loadWalkHotspots() {
            try {
                const response = await fetch('/dashboard/daily');
                const data = await response.json();
                
                const hotspotsCard = document.getElementById('hotspots-card');
                
                if (data.context.walk_hotspots && !data.context.walk_hotspots.error) {
                    const hotspots = data.context.walk_hotspots;
                    let html = '';
                    
                    if (hotspots.length === 0) {
                        html = '<div style="color: #a6adc8; font-size: 0.9em;">No optimal walk times found in the next 3 days</div>';
                    } else {
                        // Show top 3 hotspots
                        hotspots.slice(0, 3).forEach((spot, index) => {
                            const time = new Date(spot.time);
                            const dateStr = time.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            const timeStr = time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                            
                            // Score color
                            let scoreColor = '#ff6b6b'; // Red for low scores
                            if (spot.score >= 5) scoreColor = '#50fa7b'; // Green for high scores
                            else if (spot.score >= 3) scoreColor = '#ffb86c'; // Orange for medium scores
                            
                            html += `
                                <div style="${index > 0 ? 'border-top: 1px solid rgba(68, 71, 90, 0.5); margin-top: 10px; padding-top: 10px;' : ''}">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <span style="font-weight: 600; color: #f1f1f1;">${dateStr} at ${timeStr}</span>
                                        <span style="font-weight: 600; color: ${scoreColor};">${spot.score}/${spot.max_score}</span>
                                    </div>
                                    <div style="font-size: 0.85em; color: #a6adc8; margin-bottom: 2px;">
                                        Tide: ${spot.tide_height}m${spot.temperature !== null ? ` ‚Ä¢ Temp: ${spot.temperature}¬∞C` : ''}
                                    </div>
                            `;
                            
                            if (spot.conditions && spot.conditions.length > 0) {
                                html += '<div style="font-size: 0.85em; color: #a6adc8;">';
                                spot.conditions.forEach(condition => {
                                    html += `<div>‚Ä¢ ${condition}</div>`;
                                });
                                html += '</div>';
                            }
                            
                            html += '</div>';
                        });
                    }
                    
                    hotspotsCard.querySelector('.card-content').innerHTML = html;
                } else {
                    hotspotsCard.querySelector('.card-content').innerHTML = 
                        '<div class="error">' + (data.context.walk_hotspots?.error || 'Failed to load walk hotspots') + '</div>';
                }
            } catch (error) {
                console.error('Error loading walk hotspots:', error);
                document.getElementById('hotspots-card').querySelector('.card-content').innerHTML = 
                    '<div class="error">Failed to load walk hotspots</div>';
            }
        }
        
        // Load quick status
        async function loadQuickStatus() {
            try {
                const response = await fetch('/dashboard/health-metrics');
                const data = await response.json();
                
                const statusGrid = document.getElementById('statusGrid');
                let html = '';
                
                // Recovery
                if (data.recovery_score) {
                    const recovery = data.recovery_score.latest || 0;
                    const statusClass = recovery >= 67 ? 'green' : recovery >= 34 ? 'yellow' : 'red';
                    const badgeClass = recovery >= 67 ? 'badge-green' : recovery >= 34 ? 'badge-yellow' : 'badge-red';
                    const statusText = recovery >= 67 ? 'Ready' : recovery >= 34 ? 'Moderate' : 'Rest Needed';
                    
                    html += `
                        <div class="status-card ${statusClass}">
                            <div class="status-label">Recovery</div>
                            <div class="status-value">${recovery}%</div>
                            <div class="status-badge ${badgeClass}">${statusText}</div>
                        </div>
                    `;
                }
                
                // HRV
                if (data.hrv) {
                    const hrv = data.hrv.latest || 0;
                    const avg7 = data.hrv.avg_7_days || hrv;
                    const trend = hrv > avg7 ? '‚Üë' : hrv < avg7 ? '‚Üì' : '‚Üí';
                    const trendColor = hrv > avg7 ? '#50fa7b' : hrv < avg7 ? '#ff6b6b' : '#ffb86c';
                    
                    html += `
                        <div class="status-card">
                            <div class="status-label">HRV</div>
                            <div class="status-value">${hrv}<span style="font-size: 0.5em;">ms</span></div>
                            <div style="color: ${trendColor}; font-size: 1.2em; font-weight: 600;">${trend} vs 7d avg</div>
                        </div>
                    `;
                }
                
                // Sleep
                if (data.sleep_hours) {
                    const sleep = data.sleep_hours.latest || 0;
                    const statusClass = sleep >= 7 ? 'green' : sleep >= 6 ? 'yellow' : 'red';
                    const quality = sleep >= 7 ? 'Good' : sleep >= 6 ? 'Fair' : 'Poor';
                    
                    html += `
                        <div class="status-card ${statusClass}">
                            <div class="status-label">Sleep</div>
                            <div class="status-value">${sleep.toFixed(1)}<span style="font-size: 0.5em;">h</span></div>
                            <div style="color: var(--text-secondary); font-size: 0.9em;">${quality}</div>
                        </div>
                    `;
                }
                
                // Strain
                if (data.strain) {
                    const strain = data.strain.latest || 0;
                    const statusClass = strain <= 10 ? 'green' : strain <= 14 ? 'yellow' : 'red';
                    
                    html += `
                        <div class="status-card ${statusClass}">
                            <div class="status-label">Yesterday's Strain</div>
                            <div class="status-value">${strain.toFixed(1)}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9em;">0-21 scale</div>
                        </div>
                    `;
                }
                
                statusGrid.innerHTML = html;
                
                // Generate recommendation
                const recovery = data.recovery_score?.latest || 0;
                const sleep = data.sleep_hours?.latest || 0;
                const strain = data.strain?.latest || 0;
                
                let recommendation = '';
                
                if (recovery >= 67 && sleep >= 7) {
                    recommendation = 'üí™ <strong>Great status!</strong> You\'re well recovered with good sleep. Perfect day for a challenging workout or important activities.';
                } else if (recovery >= 67 && sleep < 7) {
                    recommendation = '‚ö° <strong>Good recovery</strong> but sleep was short. Consider prioritizing rest tonight to maintain your recovery.';
                } else if (recovery < 67 && strain > 14) {
                    recommendation = '‚ö†Ô∏è <strong>High strain with lower recovery.</strong> Focus on active recovery, good nutrition, and early bedtime tonight.';
                } else if (recovery < 67 && sleep < 6) {
                    recommendation = 'üò¥ <strong>Recovery needs attention.</strong> Prioritize sleep and light activity today. Your body needs rest.';
                } else if (recovery >= 34 && recovery < 67) {
                    recommendation = 'üéØ <strong>Moderate status.</strong> Good for moderate training or work. Avoid overexertion and focus on quality rest.';
                } else {
                    recommendation = 'üîã <strong>Rest and recovery mode.</strong> Listen to your body. Light movement, good nutrition, and sleep are priorities.';
                }
                
                document.getElementById('recommendation').innerHTML = `
                    <div class="recommendation">
                        ${recommendation}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading quick status:', error);
                document.getElementById('statusGrid').innerHTML = '<div class="error">Unable to load status</div>';
            }
        }
        
        // Load all data
        loadQuickStatus();
        loadHealthMetrics();
        loadWeather();
        loadTransport();
        loadTideData();
        loadWalkHotspots();
        
        // Auto-refresh transport and tide data every 30 seconds
        setInterval(loadTransport, 30000);
        setInterval(loadTideData, 30000);
    </script>
</body>
</html>
